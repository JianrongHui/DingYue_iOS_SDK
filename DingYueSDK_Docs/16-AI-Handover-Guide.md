# DingYueSDK ç§æœ‰åŒ–é¡¹ç›® - AI åŠ©æ‰‹äº¤æ¥æŒ‡å—

> ç”¨é€”ï¼šå°†é¡¹ç›®å·¥ä½œäº¤æ¥ç»™æ–°çš„ AI åŠ©æ‰‹æ—¶ä½¿ç”¨
> æœ€åæ›´æ–°ï¼š2026-01-04

---

## é¡¹ç›®èƒŒæ™¯

ä½ æ­£åœ¨æ¥æ‰‹ DingYueSDK ç§æœ‰åŒ–æ”¹é€ é¡¹ç›®ã€‚è¿™æ˜¯ä¸€ä¸ª iOS SDK é¡¹ç›®ï¼ŒåŸæœ¬ä¾èµ– DingYue äº‘æœåŠ¡ï¼Œç°åœ¨è¦æ”¹é€ ä¸ºå¯è‡ªæ‰˜ç®¡çš„ç§æœ‰åŒ–ç‰ˆæœ¬ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- ä¿ç•™ SDK çš„ H5 é¡µé¢ä¸‹è½½/æ¸²æŸ“èƒ½åŠ›
- æ›¿æ¢åç«¯ä¸ºè‡ªå»ºæœåŠ¡ï¼ˆCloudflare Workers + D1 + R2ï¼‰
- å®ç°é…ç½®ä¸‹å‘ã€äº‹ä»¶ä¸ŠæŠ¥ã€H5 åŒ…ç®¡ç†ç­‰åŠŸèƒ½
- é›†æˆ RevenueCat å¤„ç† iOS å†…è´­

**é¡¹ç›®ä»“åº“**ï¼š`/Users/kingsoft/Documents/Github/DingYue_iOS_SDK`

---

## æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        iOS App                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              DingYueSDK (Swift)                      â”‚    â”‚
â”‚  â”‚  â€¢ ConfigProvider (é…ç½®æ‹‰å–)                         â”‚    â”‚
â”‚  â”‚  â€¢ EventReporter (äº‹ä»¶ä¸ŠæŠ¥)                          â”‚    â”‚
â”‚  â”‚  â€¢ H5PackageManager (åŒ…ä¸‹è½½/è§£å‹/ç¼“å­˜)               â”‚    â”‚
â”‚  â”‚  â€¢ PayWallController / GuideController (H5 å®¹å™¨)     â”‚    â”‚
â”‚  â”‚  â€¢ RevenueCat PurchaseProvider (å†…è´­)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTPS + HMAC-SHA256
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Backend (Cloudflare)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Workers    â”‚  â”‚     D1       â”‚  â”‚     R2       â”‚       â”‚
â”‚  â”‚  (Express)   â”‚  â”‚ (PostgreSQL) â”‚  â”‚ (å¯¹è±¡å­˜å‚¨)   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                              â”‚
â”‚  è·¯ç”±ï¼š                                                      â”‚
â”‚  â€¢ POST /v1/sdk/config  â†’ é…ç½®ä¸‹å‘ï¼ˆè§„åˆ™å¼•æ“+å®éªŒåˆ†æµï¼‰      â”‚
â”‚  â€¢ POST /v1/sdk/events  â†’ äº‹ä»¶å…¥åº“ + GA4/Firebase è½¬å‘      â”‚
â”‚  â€¢ /v1/admin/*          â†’ ç®¡ç†åå° API                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Web Admin (React)                         â”‚
â”‚  â€¢ Apps / Placements / Variants ç®¡ç†                         â”‚
â”‚  â€¢ è§„åˆ™å¯è§†åŒ–æ„å»ºå™¨                                          â”‚
â”‚  â€¢ å®éªŒç®¡ç†ï¼ˆA/B æµ‹è¯•ï¼‰                                      â”‚
â”‚  â€¢ äº‹ä»¶æŸ¥è¯¢ä¸æ¼æ–—åˆ†æ                                        â”‚
â”‚  â€¢ H5 åŒ…ä¸Šä¼ ä¸ç‰ˆæœ¬ç®¡ç†                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç›®å½•ç»“æ„

```
DingYue_iOS_SDK/
â”œâ”€â”€ DingYue_iOS_SDK/Classes/    # iOS SDK æºç  (Swift)
â”‚   â””â”€â”€ API/
â”‚       â”œâ”€â”€ DYMEventReporter.swift
â”‚       â”œâ”€â”€ DYMPayWallController.swift
â”‚       â”œâ”€â”€ DYMGuideController.swift
â”‚       â””â”€â”€ ...
â”œâ”€â”€ server/                      # åç«¯æœåŠ¡ (Express + TypeScript)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ middleware/          # HMAC é‰´æƒç­‰ä¸­é—´ä»¶
â”‚       â”œâ”€â”€ modules/             # config, events, packages æ¨¡å—
â”‚       â”œâ”€â”€ lib/                 # è§„åˆ™å¼•æ“, analytics è½¬å‘
â”‚       â””â”€â”€ db/migrations/       # æ•°æ®åº“è¿ç§»è„šæœ¬
â”œâ”€â”€ web-admin/                   # ç®¡ç†åå° (React + Vite + TypeScript)
â”‚   â””â”€â”€ src/pages/               # Apps, Placements, Variants, Rules, etc.
â”œâ”€â”€ H5Samples/                   # H5 ç¤ºä¾‹åŒ… (Paywall, Guide)
â””â”€â”€ DingYueSDK_Docs/             # æŠ€æœ¯è§„èŒƒæ–‡æ¡£ (å¿…è¯»!)
```

---

## å¿…è¯»æ–‡æ¡£

æŒ‰ä»¥ä¸‹é¡ºåºé˜…è¯» `DingYueSDK_Docs/` ç›®å½•ï¼š

1. **01-Solution-Overview.md** - æ€»ä½“æ¶æ„ä¸æ ¸å¿ƒæµç¨‹
2. **02-Backend-APIs.md** - API æ¥å£è§„èŒƒä¸ HMAC ç­¾å
3. **04-Events-Dictionary.md** - äº‹ä»¶ç±»å‹ä¸å­—æ®µå®šä¹‰
4. **08-H5-Package-Spec.md** - H5 åŒ…ç»“æ„ä¸ Bridge åè®®
5. **11-SDK-Event-Spec.md** - iOS SDK äº‹ä»¶å­—æ®µè§„èŒƒ
6. **12-OpenAPI-Full.yaml** - å®Œæ•´ OpenAPI å®šä¹‰
7. **15-Progress-Tracker.md** - **å½“å‰è¿›åº¦ä¸å¾…åŠ** â­

---

## å…³é”®æŠ€æœ¯è§„èŒƒ

### HMAC-SHA256 ç­¾åï¼ˆSDK â†’ åç«¯ï¼‰

```
Canonical String = METHOD\nPATH\nTIMESTAMP\nNONCE\nSHA256(body)
Signature = hex(HMAC-SHA256(app_key, canonical_string))

Headers:
- X-App-Id: åº”ç”¨ ID
- X-Timestamp: Unix æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
- X-Nonce: UUID
- X-Signature: ç­¾åç»“æœ

éªŒè¯è§„åˆ™ï¼š
- æ—¶é—´çª—å£ï¼šÂ±5 åˆ†é’Ÿ
- nonceï¼š10 åˆ†é’Ÿå†…ä¸å¯å¤ç”¨
```

### äº‹ä»¶å¿…å¡«å­—æ®µ

```swift
event_id, event_name, timestamp, app_id, placement_id, variant_id,
placement_version, sdk_version, app_version, rc_app_user_id,
device_id, session_id, locale
```

### è§„åˆ™å¼•æ“ DSL

```json
{
  "match": "all",  // æˆ– "any"
  "conditions": [
    { "field": "device.locale", "op": "eq", "value": "zh-Hans-CN" },
    { "field": "session.session_count", "op": "gte", "value": 3 }
  ]
}
```

æ”¯æŒæ“ä½œç¬¦ï¼š`eq`, `ne`, `in`, `notIn`, `gt`, `gte`, `lt`, `lte`, `contains`, `regex`

### å®éªŒåˆ†æµ

```
bucket = hash(seed + rc_app_user_id) % 100
æŒ‰ variant æƒé‡åˆ†é…ç”¨æˆ·
```

---

## å½“å‰è¿›åº¦

| é‡Œç¨‹ç¢‘ | è¿›åº¦ | çŠ¶æ€ |
|--------|------|------|
| M1 åå°åŸºç¡€èƒ½åŠ› | 90% | ğŸŸ¢ æ¥è¿‘å®Œæˆ |
| M2 ç®¡ç†åå° | 90% | ğŸŸ¢ æ¥è¿‘å®Œæˆ |
| M3 SDK æ”¹é€  | 95% | ğŸŸ¢ æ¥è¿‘å®Œæˆ |
| M4 æ•°æ®ä¸åˆ†æ | 60% | ğŸŸ¡ è¿›è¡Œä¸­ |

### å·²å®ŒæˆåŠŸèƒ½

**åç«¯ (server/)**ï¼š
- âœ… HMAC-SHA256 é‰´æƒä¸­é—´ä»¶
- âœ… é…ç½®æ¥å£ + è§„åˆ™å¼•æ“ + å®éªŒåˆ†æµ
- âœ… äº‹ä»¶æŒä¹…åŒ–åˆ° D1
- âœ… åŒ…ç®¡ç†ï¼ˆmanifest æ ¡éªŒ + checksumï¼‰
- âœ… GA4 + Firebase äº‹ä»¶è½¬å‘
- âœ… æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆ8 å¼ è¡¨ï¼‰

**ç®¡ç†åå° (web-admin/)**ï¼š
- âœ… Apps / Placements / Variants CRUD
- âœ… è§„åˆ™å¯è§†åŒ–æ„å»ºå™¨
- âœ… å®éªŒç®¡ç†é¡µé¢
- âœ… äº‹ä»¶æŸ¥è¯¢ + æ¼æ–—åˆ†æ
- âœ… åŒ…ä¸Šä¼ ä¸ç‰ˆæœ¬ç®¡ç†

**iOS SDK**ï¼š
- âœ… HMAC ç­¾åå®ç°
- âœ… å®Œæ•´äº‹ä»¶å­—æ®µ
- âœ… page_options è‡ªåŠ¨å…³é—­æ§åˆ¶

### å¾…å®Œæˆä»»åŠ¡

| ä»»åŠ¡ | æ¨¡å— | å¤æ‚åº¦ |
|------|------|--------|
| æ¥å…¥çœŸå®åç«¯ API | Web | ä¸­ |
| ç«¯åˆ°ç«¯è”è°ƒéªŒè¯ | iOS + Backend | ä¸­ |
| analytics_sinks é…ç½®ç®¡ç† | Backend | ä½ |
| æ•°ä»“ fact_events è¡¨ä¸ ETL | Data | é«˜ |
| ç»Ÿè®¡ SQL æ¨¡æ¿éªŒè¯ | Data | ä¸­ |

---

## å¹¶è¡Œå¼€å‘å·¥ä½œæµ

æœ¬é¡¹ç›®ä½¿ç”¨ **git worktree** å®ç°å¤š AI å¹¶è¡Œå¼€å‘ï¼š

```bash
# åˆ›å»º worktree
git worktree add ../DingYue_worktree_X -b feat/xxx

# åˆå¹¶å› main
git checkout main
git merge feat/xxx --no-ff -m "Merge feat/xxx: åŠŸèƒ½æè¿°"

# æ¸…ç†
git worktree remove ../DingYue_worktree_X --force
git branch -d feat/xxx
```

å·²å®Œæˆ 3 ä¸ªé˜¶æ®µã€12 ä¸ªå¹¶è¡Œä»»åŠ¡ï¼Œè¯¦è§ `15-Progress-Tracker.md`ã€‚

---

## å¼€å‘è§„èŒƒ

1. **JSON å­—æ®µ**ï¼šä½¿ç”¨ snake_case
2. **åˆ†æ”¯å‘½å**ï¼šfeat/xxx, fix/xxx
3. **æäº¤ä¿¡æ¯**ï¼šfeat: xxx / fix: xxx
4. **ç±»å‹å®‰å…¨**ï¼šæ‰€æœ‰ä»£ç å¿…é¡»æœ‰ TypeScript/Swift ç±»å‹
5. **é”™è¯¯å¤„ç†**ï¼šå¤±è´¥äº‹ä»¶å¿…é¡»åŒ…å« error_code å’Œ error_message

---

## å¿«é€Ÿå¼€å§‹

```bash
# åç«¯å¼€å‘
cd server && npm install && npm run dev

# ç®¡ç†åå°å¼€å‘
cd web-admin && npm install && npm run dev

# iOS å¼€å‘
open DingYue.xcworkspace
```

---

## ä½ çš„è§’è‰²

ä½œä¸ºæ¥æ‰‹çš„ AI åŠ©æ‰‹ï¼Œä½ éœ€è¦ï¼š

1. **å…ˆé˜…è¯»æ–‡æ¡£**ï¼šä» DingYueSDK_Docs/ äº†è§£å®Œæ•´è§„èŒƒ
2. **æŸ¥çœ‹è¿›åº¦**ï¼šé˜…è¯» 15-Progress-Tracker.md äº†è§£å½“å‰çŠ¶æ€
3. **ç»§ç»­å¼€å‘**ï¼šæ ¹æ®å¾…åŠä»»åŠ¡ç»§ç»­æ¨è¿›
4. **ä¿æŒä¸€è‡´æ€§**ï¼šéµå¾ªç°æœ‰ä»£ç é£æ ¼å’Œè§„èŒƒ
5. **æ›´æ–°æ–‡æ¡£**ï¼šå®Œæˆä»»åŠ¡åæ›´æ–°è¿›åº¦è¿½è¸ªæ–‡æ¡£

å¦‚éœ€å¹¶è¡Œå¼€å‘ï¼Œå¯åˆ›å»ºå¤šä¸ª worktree åˆ†é…ç»™ä¸åŒ AI åŠ©æ‰‹æ‰§è¡Œã€‚

---

## äº¤æ¥æ£€æŸ¥æ¸…å•

- [ ] å·²é˜…è¯» 01-Solution-Overview.md
- [ ] å·²é˜…è¯» 02-Backend-APIs.md
- [ ] å·²é˜…è¯» 15-Progress-Tracker.md
- [ ] äº†è§£ HMAC ç­¾åè§„èŒƒ
- [ ] äº†è§£äº‹ä»¶å­—æ®µè§„èŒƒ
- [ ] äº†è§£è§„åˆ™å¼•æ“ DSL
- [ ] äº†è§£ git worktree å·¥ä½œæµ
- [ ] ç¡®è®¤å½“å‰å¾…åŠä»»åŠ¡
